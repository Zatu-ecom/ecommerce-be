name: Deploy to GCP VM

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger from any branch
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false
        default: 'main'

env:
  IMAGE_NAME: ecommerce-backend

jobs:
  build-and-deploy:
    name: Build and Deploy to GCP VM
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # 1. Checkout Code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      # ============================================
      # 2. Set up Docker Buildx
      # ============================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ============================================
      # 3. Build Docker Image
      # ============================================
      - name: Build Docker image
        run: |
          echo "ðŸ—ï¸  Building Docker image..."
          DOCKER_BUILDKIT=1 docker build \
            --tag ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --tag ${{ env.IMAGE_NAME }}:latest \
            --cache-from ${{ env.IMAGE_NAME }}:latest \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            .
          
          echo "âœ… Image built successfully"
          docker images | grep ${{ env.IMAGE_NAME }}

      # ============================================
      # 4. Save Docker Image to tar
      # ============================================
      - name: Save Docker image
        run: |
          echo "ðŸ’¾ Saving Docker image to tar file..."
          docker save ${{ env.IMAGE_NAME }}:latest | gzip > ecommerce-backend.tar.gz
          ls -lh ecommerce-backend.tar.gz
          echo "âœ… Image saved"

      # ============================================
      # 5. Authenticate to Google Cloud
      # ============================================
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # ============================================
      # 6. Transfer Image to VM
      # ============================================
      - name: Transfer image to VM
        run: |
          echo "ðŸ“¤ Transferring Docker image to VM..."
          gcloud compute scp ecommerce-backend.tar.gz \
            ${{ secrets.GCP_VM_NAME }}:/tmp/ecommerce-backend.tar.gz \
            --zone=${{ secrets.GCP_VM_ZONE }}
          echo "âœ… Image transferred"

      # ============================================
      # 7. Deploy to GCP VM
      # ============================================
      - name: Deploy to GCP VM
        run: |
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} \
            --zone=${{ secrets.GCP_VM_ZONE }} \
            --command="
              set -e
              
              echo 'ðŸš€ Starting deployment...'
              echo '================================================'
              echo 'Branch: ${{ github.ref_name }}'
              echo 'Commit: ${{ github.sha }}'
              echo '================================================'
              
              # Navigate to app directory
              cd /home/vasugoriya1234/ecommerce-backend
              
              # Stop existing containers
              echo 'ðŸ›‘ Stopping existing containers...'
              docker-compose down || true
              
              # Remove old images (except the one we're about to load)
              echo 'ðŸ§¹ Removing old Docker images...'
              docker images | grep ${{ env.IMAGE_NAME }} | awk '{print \$3}' | xargs -r docker rmi -f 2>/dev/null || true
              
              # Load new image
              echo 'ðŸ“¦ Loading new Docker image...'
              docker load < /tmp/ecommerce-backend.tar.gz
              
              # Remove the tar file
              rm -f /tmp/ecommerce-backend.tar.gz
              
              # Verify image loaded
              echo 'âœ… Image loaded:'
              docker images | grep ${{ env.IMAGE_NAME }}
              
              # Run migrations
              echo 'ðŸ—„ï¸  Running database migrations...'
              docker-compose --profile tools run --rm migrate || echo 'âš ï¸  Migrations already up to date'
              
              # Start services
              echo 'ðŸš€ Starting services...'
              docker-compose up -d
              
              # Wait for services to be ready
              echo 'â³ Waiting for services to start...'
              sleep 5
              
              # Clean up dangling images
              echo 'ðŸ§¹ Cleaning up dangling images...'
              docker image prune -f
              
              # Show status
              echo '================================================'
              echo 'âœ… Deployment complete!'
              echo '================================================'
              docker-compose ps
              echo '================================================'
              
              # Show disk usage
              echo 'ðŸ’¾ Disk usage:'
              df -h / | tail -1
              echo '================================================'
            "

      # ============================================
      # 8. Verify Deployment
      # ============================================
      - name: Verify deployment
        run: |
          echo "â³ Waiting for application to be ready..."
          sleep 10
          
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} \
            --zone=${{ secrets.GCP_VM_ZONE }} \
            --command="
              cd /home/vasugoriya1234/ecommerce-backend
              
              echo 'ðŸ“Š Service Status:'
              docker-compose ps
              
              echo ''
              echo 'ðŸ“‹ Recent Application Logs:'
              docker-compose logs --tail=30 app
              
              echo ''
              echo 'ðŸ³ Docker Images:'
              docker images | grep -E 'REPOSITORY|ecommerce'
              
              echo ''
              echo 'ðŸ’¾ Disk Space:'
              df -h / | tail -1
            "

      # ============================================
      # 9. Notify on Success
      # ============================================
      - name: Deployment successful
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "VM: ${{ secrets.GCP_VM_NAME }}"
          echo "Image: ${{ env.IMAGE_NAME }}:latest"

      # ============================================
      # 10. Notify on Failure
      # ============================================
      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Check the logs above for details."
